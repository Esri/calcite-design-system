<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>Demos</title>
    <script src="/src/demos/_assets/head.ts"></script>
    <style>
      a {
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <button onclick="remove('calcite-icons');">Remove icon</button>

    <script type="module">
      import { LitElement } from "lit";

      class LuminaElement extends LitElement {
        static lumina = true;
      }
      class Icon extends LuminaElement {
        createRenderRoot() {
          this.el = document.querySelector("calcite-icons");
          const renderRoot = this.el.attachShadow({ mode: "open" });
          Object.defineProperty(this, "shadowRoot", {
            // Create shadow root on the proxy instance, to make Lit render content there
            value: renderRoot,
          });
          renderRoot.getRootNode().adoptedStyleSheets = [Icon.styles];
          return renderRoot;
        }
        static get isConnected() {
          return this.el.isConnected;
        }
        static tagName = "calcite-icons";
        static get styles() {
          const style = new CSSStyleSheet();
          style.replaceSync(`:host{display:inline-block}`);
          // return undefined;
          return style;
        }
      }
      class ProxyComponent extends HTMLElement {
        static lumina = true;
        constructor() {
          super();
          this._initializeComponent({ a: Icon });
        }
        connectedCallback() {
          this._litElement.connectedCallback();
        }
        _initializeComponent(module) {
          const ProxyClass = this.constructor;
          const store = this._store;

          // Support multiple components in a single file
          const LitConstructor = Object.values(module).a;

          const lazyTagName = `calcite-icons--lazy`;
          const litElement = document.createElement(lazyTagName);
          this._litElement = litElement;
          litElement.connectedCallback?.();
        }
      }

      const ProxyClass = class extends ProxyComponent {};

      customElements.define("calcite-icons--lazy", Icon);
      {
        const icon = document.createElement("calcite-icons");
        icon.icon = "check-circle";
        document.body.appendChild(icon);
      }

      customElements.define("calcite-icons", ProxyClass);
    </script>
    <script>
      const consoleLog = window.console.log;
      const registry = new FinalizationRegistry((heldValue) => {
        consoleLog(`garbage collected "${heldValue}"`);
      });

      let counter = 0;
      function remove(tagName) {
        let el = document.querySelector(tagName);
        consoleLog(`removing "${el.tagName}"`);
        registry.register(el, el.tagName + " (Proxy)");
        registry.register(el._litElement, el.tagName + " (LitElement)");
        el.remove();

        setTimeout(() => {
          el._litElement.__childPart = undefined;
          el._litElement.shadowRoot._$litPart$ = undefined;
          el._litElement.manager = undefined;
          delete el._litElement;
          (el.shadowRoot ?? el).innerHTML = "";
          (el.shadowRoot ?? document).adoptedStyleSheets = [];
          el._store = undefined;
          nukeProperties(el.shadowRoot);
          Object.getOwnPropertySymbols(el).map((property) => {
            try {
              delete el[property];
            } catch {}
          });
          Object.getOwnPropertyNames(el).map((property) => {
            try {
              delete el[property];
            } catch {}
          });
          counter += 1;
          if (counter === 1) {
            document.head.remove();
            document.body.remove();
            let Class = customElements.get(tagName);
            nukeProperties(Class);
            nukeProperties(ShadowRoot);
            nukeProperties(document);
            nukeProperties(window);
          }
        }, 1000);
      }
      function nukeProperties(Class) {
        const Object = window.Object;
        while (Class) {
          Object.getOwnPropertyNames(Class).map((property) => {
            try {
              delete Class[property];
            } catch {}
          });
          Object.getOwnPropertySymbols(Class).map((property) => {
            try {
              delete Class[property];
            } catch {}
          });
          if (Class.prototype) {
            Object.getOwnPropertyNames(Class.prototype).map((property) => {
              try {
                delete Class.prototype[property];
              } catch {}
            });
            Object.getOwnPropertySymbols(Class.prototype).map((property) => {
              try {
                delete Class.prototype[property];
              } catch {}
            });
          }
          Class = Object.getPrototypeOf(Class);
        }
        link = undefined;
      }
    </script>
    <!--<calcite-icons icon="check-circle"></calcite-icons>
    <calcite-link open>Link</calcite-link>

    <script>
      const registry = new FinalizationRegistry((heldValue) => {
        console.log(`garbage collected "${heldValue}"`);
      });

      // Icon is cleaned up fine - only calcite-link has issues
      let icon = document.querySelector("calcite-icons");
      let link = document.querySelector("calcite-link");
      customElements
        .whenDefined("calcite-link")
        .then(async () => {
          await icon.componentOnReady();
          await link.componentOnReady();
        })
        .then(() => {
          setTimeout(() => {
            clean(icon, "icon");
            clean(link, "link");
            icon = undefined;
            link = undefined;
            function clean(el) {
              registry.register(el, el.tagName + " (Proxy)");
              registry.register(el._litElement, el.tagName + " (LitElement)");
              el.remove();
            }
          }, 1000);
        });
    </script>-->
  </body>
</html>
