<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Demos</title>
  </head>
  <body>
    <button onclick="remove('calcite-icons');">Remove icon</button>
    <calcite-icons></calcite-icons>

    <script type="module">
      class ProxyComponent extends HTMLElement {
        constructor() {
          super();
          const renderRoot = this.attachShadow({ mode: "open" });
          const style = new CSSStyleSheet();
          style.replaceSync(`:host{display:inline-block}`);
          renderRoot.adoptedStyleSheets = [style];
        }
      }
      customElements.define("calcite-icons", ProxyComponent);
    </script>
    <script>
      const consoleLog = window.console.log;
      const registry = new FinalizationRegistry((heldValue) => {
        consoleLog(`garbage collected "${heldValue}"`);
      });

      let counter = 0;
      function remove(tagName) {
        let el = document.querySelector(tagName);
        consoleLog(`removing "${el.tagName}"`);
        registry.register(el, el.tagName + " (Proxy)");
        el.remove();

        setTimeout(() => {
          el.shadowRoot._$litPart$ = undefined;
          (el.shadowRoot ?? el).innerHTML = "";
          (el.shadowRoot ?? document).adoptedStyleSheets = [];
          nukeProperties(el.shadowRoot);
          Object.getOwnPropertySymbols(el).map((property) => {
            try {
              delete el[property];
            } catch {}
          });
          Object.getOwnPropertyNames(el).map((property) => {
            try {
              delete el[property];
            } catch {}
          });
          counter += 1;
          if (counter === 1) {
            document.head.remove();
            document.body.remove();
            let Class = customElements.get(tagName);
            nukeProperties(Class);
            nukeProperties(ShadowRoot);
            nukeProperties(document);
            nukeProperties(window);
          }
        }, 1000);
      }
      function nukeProperties(Class) {
        const Object = window.Object;
        while (Class) {
          Object.getOwnPropertyNames(Class).map((property) => {
            try {
              delete Class[property];
            } catch {}
          });
          Object.getOwnPropertySymbols(Class).map((property) => {
            try {
              delete Class[property];
            } catch {}
          });
          if (Class.prototype) {
            Object.getOwnPropertyNames(Class.prototype).map((property) => {
              try {
                delete Class.prototype[property];
              } catch {}
            });
            Object.getOwnPropertySymbols(Class.prototype).map((property) => {
              try {
                delete Class.prototype[property];
              } catch {}
            });
          }
          Class = Object.getPrototypeOf(Class);
        }
        link = undefined;
      }
    </script>
  </body>
</html>
